#include <stdint.h>
#include <stdlib.h>
#include "internal.h"
#include <arm_neon.h>
#include <string.h>

uint64_t seed;

uint64_t hash64(const uint8_t* const data, const uint32_t data_size) {
    uint64_t res = 0;

    for (uint32_t i = 0; i < data_size; i++) {
        res = (res ^ *(data + i)) * res;
    }

    return res;
}

struct SwiftNetHashMap hashmap_create() {
    return (struct SwiftNetHashMap){
        .items_allocated = 0xFF,
        .items = calloc(sizeof(struct SwiftNetHashMapItem), 0xFF)
    };
}

void hashmap_insert(void* const data, const uint32_t data_size, void* const value, struct SwiftNetHashMap* const hashmap) {
    // Mapping to max value of items allocated
    // Must rehash when scalling hashmap
    const uint64_t key = ((__uint128_t)hash64(data, data_size) * hashmap->items_allocated) >> 64;

    struct SwiftNetHashMapItem* current_target_item = hashmap->items + key;

    while (current_target_item->value != NULL) {
        if (current_target_item->next == NULL) {
            struct SwiftNetHashMapItem* const new_item = allocator_allocate(&hashmap_item_memory_allocator);
            current_target_item->next = new_item;
        } else {
            current_target_item = current_target_item->next;
        }
    }

    *current_target_item = (struct SwiftNetHashMapItem){
        .key_original_data = data,
        .key_original_data_size = data_size,
        .value = value,
        .next = NULL
    };
}
